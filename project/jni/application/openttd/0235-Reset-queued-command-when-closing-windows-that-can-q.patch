From e7e2c3f1392ae1d9be5e3cc96fa31d4cb894a1ea Mon Sep 17 00:00:00 2001
From: Juanjo <juanjo.ng.83@gmail.com>
Date: Mon, 14 Oct 2013 17:49:14 +0000
Subject: [PATCH 235/249] Reset queued command when closing windows that can
 queue them.

---
 src/airport_gui.cpp   | 4 +++-
 src/dock_gui.cpp      | 3 +++
 src/rail_gui.cpp      | 2 ++
 src/road_gui.cpp      | 3 +++
 src/terraform_gui.cpp | 1 +
 src/tree_gui.cpp      | 1 +
 6 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/airport_gui.cpp b/src/airport_gui.cpp
index 61c9f2d..c927ef4 100644
--- a/src/airport_gui.cpp
+++ b/src/airport_gui.cpp
@@ -28,6 +28,7 @@
 #include "hotkeys.h"
 #include "vehicle_func.h"
 #include "gui.h"
+#include "command_func.h"
 
 #include "widgets/airport_widget.h"
 
@@ -142,7 +143,7 @@ struct BuildAirToolbarWindow : Window {
 
 		DeleteWindowById(WC_BUILD_STATION, TRANSPORT_AIR);
 		DeleteWindowById(WC_SELECT_STATION, 0);
-
+		EraseQueuedTouchCommand();
 		ResetObjectToPlace();
 	}
 
@@ -243,6 +244,7 @@ public:
 
 	virtual ~BuildAirportWindow()
 	{
+		EraseQueuedTouchCommand();
 		DeleteWindowById(WC_SELECT_STATION, 0);
 	}
 
diff --git a/src/dock_gui.cpp b/src/dock_gui.cpp
index 460ae57..934ff9e 100644
--- a/src/dock_gui.cpp
+++ b/src/dock_gui.cpp
@@ -103,6 +103,7 @@ struct BuildDocksToolbarWindow : Window {
 
 	~BuildDocksToolbarWindow()
 	{
+		if (_thd.GetCallbackWnd() == this) this->OnPlaceObjectAbort();
 		if (_settings_client.gui.link_terraform_toolbar) DeleteWindowById(WC_SCEN_LAND_GEN, 0, false);
 	}
 
@@ -279,6 +280,7 @@ struct BuildDocksToolbarWindow : Window {
 		DeleteWindowById(WC_BUILD_DEPOT, TRANSPORT_WATER);
 		DeleteWindowById(WC_SELECT_STATION, 0);
 		DeleteWindowByClass(WC_BUILD_BRIDGE);
+		EraseQueuedTouchCommand();
 	}
 
 	virtual void OnPlacePresize(Point pt, TileIndex tile_from)
@@ -558,6 +560,7 @@ public:
 				this->LowerWidget(_ship_depot_direction + WID_BDD_X);
 				if (_settings_client.sound.click_beep) SndPlayFx(SND_15_BEEP);
 				UpdateDocksDirection();
+				EraseQueuedTouchCommand();
 				this->SetDirty();
 				break;
 		}
diff --git a/src/rail_gui.cpp b/src/rail_gui.cpp
index d537646..ce9d105 100644
--- a/src/rail_gui.cpp
+++ b/src/rail_gui.cpp
@@ -405,6 +405,7 @@ struct BuildRailToolbarWindow : Window {
 
 	~BuildRailToolbarWindow()
 	{
+		if (_thd.GetCallbackWnd() == this) this->OnPlaceObjectAbort();
 		if (_settings_client.gui.link_terraform_toolbar) DeleteWindowById(WC_SCEN_LAND_GEN, 0, false);
 	}
 
@@ -754,6 +755,7 @@ struct BuildRailToolbarWindow : Window {
 		DeleteWindowById(WC_BUILD_WAYPOINT, TRANSPORT_RAIL);
 		DeleteWindowById(WC_SELECT_STATION, 0);
 		DeleteWindowByClass(WC_BUILD_BRIDGE);
+		EraseQueuedTouchCommand();
 	}
 
 	virtual void OnPlacePresize(Point pt, TileIndex tile_from)
diff --git a/src/road_gui.cpp b/src/road_gui.cpp
index ef6c6d3..1b7ea07 100644
--- a/src/road_gui.cpp
+++ b/src/road_gui.cpp
@@ -309,6 +309,7 @@ struct BuildRoadToolbarWindow : Window {
 
 	~BuildRoadToolbarWindow()
 	{
+		if (_thd.GetCallbackWnd() == this) this->OnPlaceObjectAbort();
 		if (_settings_client.gui.link_terraform_toolbar) DeleteWindowById(WC_SCEN_LAND_GEN, 0, false);
 	}
 
@@ -531,6 +532,7 @@ struct BuildRoadToolbarWindow : Window {
 		DeleteWindowById(WC_BUILD_DEPOT, TRANSPORT_ROAD);
 		DeleteWindowById(WC_SELECT_STATION, 0);
 		DeleteWindowByClass(WC_BUILD_BRIDGE);
+		EraseQueuedTouchCommand();
 	}
 
 	virtual void OnPlaceDrag(ViewportPlaceMethod select_method, ViewportDragDropSelectionProcess select_proc, Point pt)
@@ -1029,6 +1031,7 @@ struct BuildRoadStationWindow : public PickerWindowBase {
 				if (_settings_client.sound.click_beep) SndPlayFx(SND_15_BEEP);
 				this->SetDirty();
 				DeleteWindowById(WC_SELECT_STATION, 0);
+				EraseQueuedTouchCommand();
 				break;
 
 			case WID_BROS_LT_OFF:
diff --git a/src/terraform_gui.cpp b/src/terraform_gui.cpp
index 922071c..c6b3dff 100644
--- a/src/terraform_gui.cpp
+++ b/src/terraform_gui.cpp
@@ -288,6 +288,7 @@ struct TerraformToolbarWindow : Window {
 	{
 		DeleteWindowById(WC_BUILD_OBJECT, 0);
 		this->RaiseButtons();
+		EraseQueuedTouchCommand();
 		ResetObjectToPlace();
 	}
 
diff --git a/src/tree_gui.cpp b/src/tree_gui.cpp
index bcd3281..eac8584 100644
--- a/src/tree_gui.cpp
+++ b/src/tree_gui.cpp
@@ -174,6 +174,7 @@ public:
 		this->RaiseButtons();
 
 		ResetObjectToPlace();
+		EraseQueuedTouchCommand();
 	}
 };
 
-- 
1.8.1.2

