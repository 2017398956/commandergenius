From 72663a2c57f50dcd41eebe90c60a46e4f3ffb2b4 Mon Sep 17 00:00:00 2001
From: Juanjo <juanjo.ng.83@gmail.com>
Date: Mon, 24 Jun 2013 18:07:55 +0200
Subject: [PATCH 218/249] Changes on viewport related files to deal with
 touchscreen options.

---
 src/viewport.cpp |  3 ++-
 src/window.cpp   | 18 +++++++++++-------
 2 files changed, 13 insertions(+), 8 deletions(-)

diff --git a/src/viewport.cpp b/src/viewport.cpp
index 07f02af..81a9dca 100644
--- a/src/viewport.cpp
+++ b/src/viewport.cpp
@@ -2000,6 +2000,8 @@ static void PlaceObject()
 
 bool HandleViewportClicked(const ViewPort *vp, int x, int y)
 {
+	if (_move_pressed) return false;
+
 	const Vehicle *v = CheckClickOnVehicle(vp, x, y);
 
 	if (_thd.place_mode & HT_VEHICLE) {
@@ -2972,7 +2974,6 @@ EventState VpHandlePlaceSizingDrag()
 
 place_mouseup:
 	w->OnPlaceMouseUp(_thd.select_method, _thd.select_proc, _thd.selend, TileVirtXY(_thd.selstart.x, _thd.selstart.y), TileVirtXY(_thd.selend.x, _thd.selend.y));
-
 	return ES_HANDLED;
 }
 
diff --git a/src/window.cpp b/src/window.cpp
index 9b4f416..ec3c647 100644
--- a/src/window.cpp
+++ b/src/window.cpp
@@ -2439,7 +2439,9 @@ static EventState HandleViewportScroll()
 	 * outside of the window and should not left-mouse scroll anymore. */
 	if (_last_scroll_window == NULL) _last_scroll_window = FindWindowFromPt(_cursor.pos.x, _cursor.pos.y);
 
-	if (_last_scroll_window == NULL || !(_right_button_down || scrollwheel_scrolling || (_settings_client.gui.left_mouse_btn_scrolling && _left_button_down))) {
+
+	if (_last_scroll_window == NULL || !(_right_button_down || scrollwheel_scrolling ||
+			(_left_button_down && (_move_pressed || _settings_client.gui.left_mouse_btn_scrolling)))) {
 		_cursor.fix_at = false;
 		_scrolling_viewport = false;
 		_last_scroll_window = NULL;
@@ -2829,6 +2831,12 @@ static void MouseLoop(MouseClick click, int mousewheel)
 	 * But there is no company related window open anyway, so _current_company is not used. */
 	assert(HasModalProgress() || IsLocalCompany());
 
+	int x = _cursor.pos.x;
+	int y = _cursor.pos.y;
+	Window *w = FindWindowFromPt(x, y);
+	if (w == NULL) return;
+	ViewPort *vp = IsPtInWindowViewport(w, x, y);
+
 	HandlePlacePresize();
 	UpdateTileSelection();
 
@@ -2843,13 +2851,9 @@ static void MouseLoop(MouseClick click, int mousewheel)
 	bool scrollwheel_scrolling = _settings_client.gui.scrollwheel_scrolling == 1 && (_cursor.v_wheel != 0 || _cursor.h_wheel != 0);
 	if (click == MC_NONE && mousewheel == 0 && !scrollwheel_scrolling) return;
 
-	int x = _cursor.pos.x;
-	int y = _cursor.pos.y;
-	Window *w = FindWindowFromPt(x, y);
 	if (w == NULL) return;
 
-	if (click != MC_HOVER && !MaybeBringWindowToFront(w)) return;
-	ViewPort *vp = IsPtInWindowViewport(w, x, y);
+	if (click != MC_NONE && click != MC_HOVER && !MaybeBringWindowToFront(w)) return;
 
 	/* Don't allow any action in a viewport if either in menu or when having a modal progress window */
 	if (vp != NULL && (_game_mode == GM_MENU || HasModalProgress())) return;
@@ -2870,7 +2874,7 @@ static void MouseLoop(MouseClick click, int mousewheel)
 				DEBUG(misc, 2, "Cursor: 0x%X (%d)", _cursor.sprite, _cursor.sprite);
 				if (!HandleViewportClicked(vp, x, y) &&
 						!(w->flags & WF_DISABLE_VP_SCROLL) &&
-						_settings_client.gui.left_mouse_btn_scrolling) {
+						(_settings_client.gui.left_mouse_btn_scrolling || _move_pressed)) {
 					_scrolling_viewport = true;
 					_cursor.fix_at = false;
 				}
-- 
1.8.1.2

